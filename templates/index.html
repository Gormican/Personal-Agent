<!doctype html><meta charset="utf-8">
<title>Personal Agent</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:760px;margin:40px auto;line-height:1.4}
  .nav{position:sticky;top:0;display:flex;gap:.5rem;padding:.6rem .8rem;border:1px solid #eee;border-radius:10px;margin-bottom:1rem;background:#fff}
  .nav a{text-decoration:none;border:1px solid #ddd;border-radius:8px;padding:.35rem .6rem;color:#111}
  .nav a:hover{background:#f5f5f5}
  h1,h2{margin:.2em 0}
  .row{display:flex;gap:.5rem;margin:.3rem 0}
  .box{padding:.75rem;border:1px solid #ddd;border-radius:8px;margin-top:.75rem;white-space:pre-wrap}
  /* pills + remove button */
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border:1px solid #bbb;border-radius:999px;margin:.15rem .25rem 0 0}
  .pill button{border:none;background:transparent;cursor:pointer;font-size:14px;line-height:1;padding:0 .2rem}
  .pill button:hover{opacity:.7}
</style>

<nav class="nav">
  <a href="/ui">Home</a>
  <a href="/docs">Docs</a>
  <a href="/healthz">Health</a>
</nav>

<h2>Morning report</h2>
<label><input type="checkbox" id="mrSmart"> Smart summary</label>
<div class="row">
  <button id="mrUseLoc" type="button">Use my location</button>
  <button id="mrPlay" type="button">▶ Play Morning Report</button>
</div>
<audio id="mrAudio" controls class="box"></audio>
<pre id="mrText" class="box"></pre>

<script>
(function(){
  const audio = document.getElementById('mrAudio');
  const textBox = document.getElementById('mrText');
  const smartBox = document.getElementById('mrSmart');
  let coords = null;

  document.getElementById('mrUseLoc').onclick = async ()=>{
    try{
      const pos = await navigator.geolocation.getCurrentPosition(
        p => p, e => { throw e; }, { enableHighAccuracy: true, timeout: 8000 }
      );
      coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      textBox.textContent = `Location set: ${coords.lat.toFixed(3)}, ${coords.lon.toFixed(3)}`;
    }catch(e){
      textBox.textContent = 'Location permission denied or unavailable.';
    }
  };

  document.getElementById('mrPlay').onclick = async ()=>{
    const params = new URLSearchParams();
    if (smartBox.checked) params.set('smart','true');
    if (coords){ params.set('lat', coords.lat); params.set('lon', coords.lon); }
    const url = '/report/morning/speak?' + params.toString();

    textBox.textContent = 'Preparing your report…';
    const r1 = await fetch('/report/morning?' + params.toString());
    if (r1.ok){ const j = await r1.json(); textBox.textContent = j.text; }

    const r = await fetch(url);
    if(!r.ok){ textBox.textContent += '\n\nAudio error: ' + await r.text(); return; }
    const buf = await r.arrayBuffer();
    audio.src = URL.createObjectURL(new Blob([buf], {type:'audio/mpeg'}));
    audio.play();
  };
})();
</script>

<h1>News search</h1>
<form id="search">
  <div class="row">
    <input name="topic" id="topic" placeholder="e.g., Padres or Taylor Swift" required style="flex:1">
    <button id="searchBtn">Search</button>
  </div>
</form>
<div class="row">
  <button id="save" disabled>Save current topic</button>
  <button id="show">Show my feed</button>
</div>
<div id="status" style="min-height:1.2rem"></div>
<h2>Study helper</h2>
<textarea id="q" rows="4" class="box" placeholder="Ask a study question, e.g., 'Workup of painless jaundice in a 60-year-old'"></textarea>
<div class="row"><button id="ask">Ask</button></div>
<pre id="studyOut" class="box"></pre>

<script>
document.querySelector('#ask').addEventListener('click', async ()=>{
  const q = document.querySelector('#q').value.trim();
  const out = document.querySelector('#studyOut');
  if(!q){ out.textContent = 'Type a question first.'; return; }
  out.textContent = 'Thinking…';
  const r = await fetch('/study/ask', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({question:q})
  });
  if(!r.ok){ out.textContent = 'Server error: ' + await r.text(); return; }
  const j = await r.json();
  out.textContent = j.answer || '(no answer)';
});
</script>

<h2>Results</h2>
<pre id="out" class="box"></pre>

<h2>My topics</h2>
<div id="topics" class="box"></div>

<h2>My feed</h2>
<div id="feed" class="box"></div>

<script>
const $ = s => document.querySelector(s);
const out = $('#out'), feed = $('#feed'), topicsBox = $('#topics'), status = $('#status'), saveBtn = $('#save');
let lastTopic = null;

async function getPrefs(){ const r = await fetch('/prefs/news'); return await r.json(); }
async function savePrefs(topics){
  const r = await fetch('/prefs/news',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topics})});
  return await r.json();
}
function showTopics(list){
  const items = list || [];
  topicsBox.innerHTML = items.length
    ? items.map(t=>`<span class="pill">${t}<button aria-label="Remove ${t}" data-del="${t}">×</button></span>`).join(' ')
    : 'No topics saved yet.';
}

$('#search').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const topic = new FormData(e.target).get('topic').trim();
  if(!topic) return;
  lastTopic = topic;
  saveBtn.disabled = false;
  status.textContent = `Searched: ${topic}`;
  const r = await fetch('/news?topic='+encodeURIComponent(topic));
  out.textContent = JSON.stringify(await r.json(), null, 2);
});

saveBtn.addEventListener('click', async ()=>{
  if(!lastTopic) return;
  const prefs = await getPrefs(); const set = new Set(prefs.topics || []); set.add(lastTopic);
  const saved = Array.from(set);
  await savePrefs(saved);
  showTopics(saved);
  status.textContent = `Saved topic: ${lastTopic}`;
});

$('#show').addEventListener('click', async ()=>{
  const r = await fetch('/news/for-me'); const j = await r.json();
  if(!j.buckets?.length){ feed.textContent = 'No saved topics yet.'; return; }
  feed.innerHTML = j.buckets.map(b=>{
    const lines = (b.articles||[]).map(a=>`• ${a.title}\n  ${a.link}`).join('\n');
    return `# ${b.topic}\n${lines}`;
  }).join('\n\n');
});

topicsBox.addEventListener('click', async (e)=>{
  const t = e.target?.dataset?.del;
  if(!t) return;
  const prefs = await getPrefs();
  const saved = (prefs.topics || []).filter(x => x !== t);
  await savePrefs(saved);
  showTopics(saved);
  status.textContent = `Removed topic: ${t}`;
});


// Remove topic via (×)
topicsBox.addEventListener('click', async (e)=>{
  const t = e.target?.dataset?.del;
  if(!t) return;
  const prefs = await getPrefs();
  const saved = (prefs.topics || []).filter(x => x !== t);
  await savePrefs(saved);
  showTopics(saved);
  status.textContent = `Removed topic: ${t}`;
});

// initial load of saved topics
getPrefs().then(p=>showTopics(p.topics||[])).catch(()=>showTopics([]));
</script>


