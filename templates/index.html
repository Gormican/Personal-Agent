<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Personal Agent</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; margin: 2rem; line-height: 1.45; }
    h1, h2 { margin-top: 1.2rem; }
    .row { display: flex; gap: .5rem; align-items: center; margin: .5rem 0; flex-wrap: wrap; }
    .box { border: 1px solid #ccc; padding: .7rem; border-radius: 8px; margin: .4rem 0; white-space: pre-wrap; }
    input[type="text"], input[type="url"], input[type="number"] { flex: 1; min-width: 220px; padding: .5rem .6rem; border: 1px solid #ccc; border-radius: 6px; }
    button { padding: .45rem .7rem; border: 1px solid #bbb; border-radius: 6px; background: #fff; cursor: pointer; }
    button:hover { background: #f7f7f7; }
    .muted { color: #777; font-size: .9em; }
    .ok { color: #137333; }
    .err { color: #b00020; }
    @media (max-width: 520px) { body { margin: 1rem; } }
  </style>
</head>
<body>
  <h1>Personal Agent</h1>

  <!-- Morning report -->
  <h2>Morning report</h2>
  <label><input type="checkbox" id="mrSmart"> Smart summary</label>
  <div class="row">
    <button id="mrUseLoc" type="button">Use my location</button>
    <button id="mrPlay" type="button">▶ Play Morning Report</button>
  </div>
  <audio id="mrAudio" controls class="box"></audio>
  <pre id="mrText" class="box"></pre>

  <!-- News search -->
  <h2>News search</h2>
  <div class="row">
    <input id="q" type="text" placeholder="e.g., Padres or Taylor Swift">
    <button id="search">Search</button>
    <button id="save">Save current topic</button>
  </div>
  <div id="resultsBox" class="box"></div>

  <!-- My topics -->
  <h2>My topics</h2>
  <div id="topicsBox" class="box"></div>

  <!-- Settings -->
  <h2>Settings</h2>
  <div id="settingsMsg" class="muted"></div>

  <div class="box">
    <strong>Home location</strong>
    <div class="row">
      <input id="homeLat" type="number" step="0.000001" placeholder="lat e.g. 32.685">
      <input id="homeLon" type="number" step="0.000001" placeholder="lon e.g. -117.183">
      <input id="homeTz"  type="text" placeholder='tz e.g. "America/Los_Angeles"'>
    </div>
    <div class="row">
      <button id="btnUseLoc">Use current location</button>
      <button id="btnSaveHome">Save home</button>
      <button id="btnLoadHome">Load saved</button>
    </div>
  </div>

  <div class="box">
    <strong>Calendar</strong>
    <div class="row">
      <input id="calUrl" type="url" placeholder="ICS URL (Google Calendar → Secret iCal address)">
    </div>
    <div class="row">
      <button id="btnSaveCal">Save calendar</button>
      <button id="btnLoadCal">Load saved</button>
    </div>
  </div>

  <!-- Study helper (kept at bottom) -->
  <h2>Study helper</h2>
  <div class="row">
    <input id="studyQ" type="text" placeholder="Ask a study question…">
    <button id="studyAsk">Ask</button>
  </div>
  <pre id="studyA" class="box"></pre>

<script>
(async function(){
  // ---------- News search ----------
  const qBox = document.getElementById('q');
  const resBox = document.getElementById('resultsBox');
  const topicsBox = document.getElementById('topicsBox');

  document.getElementById('search').onclick = async ()=>{
    resBox.textContent = 'Searching…';
    const q = qBox.value.trim();
    if(!q){ resBox.textContent='Enter a topic'; return; }
    const r = await fetch('/news?topic='+encodeURIComponent(q));
    resBox.textContent = r.ok ? (await r.text()) : ('Error: ' + await r.text());
  };

  document.getElementById('save').onclick = async ()=>{
    const topic = qBox.value.trim();
    if(!topic){ alert('No topic to save'); return; }
    let current = [];
    try{
      const r = await fetch('/prefs/news');
      if(r.ok) current = (await r.json()).topics || [];
    }catch{}
    if (!current.includes(topic)) current.push(topic);
    const r = await fetch('/prefs/news',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({topics: current})
    });
    if(r.ok){ renderTopics((await r.json()).topics); }
  };

  async function renderTopics(topics){
    if(!topics || topics.length===0){ topicsBox.textContent='(none)'; return; }
    topicsBox.innerHTML = topics.map(t=>
      `<div>${t} <button onclick="removeTopic('${t}')">✖</button></div>`
    ).join('');
  }
  window.removeTopic = async (topic)=>{
    let current = [];
    try{ const r = await fetch('/prefs/news');
         if(r.ok) current = (await r.json()).topics || []; }catch{}
    current = current.filter(x=>x!==topic);
    const r = await fetch('/prefs/news',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({topics: current})
    });
    if(r.ok){ renderTopics((await r.json()).topics); }
  };

  // initial topics load
  try{ const r = await fetch('/prefs/news');
       if(r.ok) renderTopics((await r.json()).topics); }catch{}

  // ---------- Study helper ----------
  const studyBtn = document.getElementById('studyAsk');
  studyBtn.onclick = async ()=>{
    const q = document.getElementById('studyQ').value.trim();
    if(!q){ return; }
    const out = document.getElementById('studyA');
    out.textContent = 'Thinking…';
    const r = await fetch('/study/ask',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({question:q})
    });
    out.textContent = r.ok ? (await r.json()).answer : ('Error: ' + await r.text());
  };

  // ---------- Morning report ----------
  const audio = document.getElementById('mrAudio');
  const textBox = document.getElementById('mrText');
  const smartBox = document.getElementById('mrSmart');
  let coords = null;

  document.getElementById('mrUseLoc').onclick = async ()=>{
    try{
      const pos = await new Promise((res,rej)=>
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:8000})
      );
      coords = {lat:pos.coords.latitude, lon:pos.coords.longitude};
      textBox.textContent = `Location set: ${coords.lat.toFixed(3)}, ${coords.lon.toFixed(3)}`;
    }catch(e){
      textBox.textContent = 'Location permission denied or unavailable.';
    }
  };

  document.getElementById('mrPlay').onclick = async ()=>{
    const params = new URLSearchParams();
    if (smartBox.checked) params.set('smart','true');
    if (coords){ params.set('lat', coords.lat); params.set('lon', coords.lon); }
    const qs = params.toString();
    const textUrl = '/report/morning' + (qs?('?'+qs):'');
    const audioUrl = '/report/morning/speak' + (qs?('?'+qs):'');

    textBox.textContent = 'Preparing your report…';
    const r1 = await fetch(textUrl);
    if(r1.ok){ textBox.textContent = (await r1.json()).text; }

    const r = await fetch(audioUrl);
    if(!r.ok){ textBox.textContent += '\n\nAudio error: ' + await r.text(); return; }
    const buf = await r.arrayBuffer();
    audio.src = URL.createObjectURL(new Blob([buf], {type:'audio/mpeg'}));
    audio.play();
  };

  // ---------- Settings: Home + Calendar ----------
  const msg = document.getElementById('settingsMsg');
  const latI = document.getElementById('homeLat');
  const lonI = document.getElementById('homeLon');
  const tzI  = document.getElementById('homeTz');
  const calI = document.getElementById('calUrl');

  function note(t, ok=false){ msg.textContent = t; msg.className = ok ? 'ok' : 'err'; }

  // Load saved home
  document.getElementById('btnLoadHome').onclick = async ()=>{
    try{
      const r = await fetch('/prefs/home');
      if(!r.ok){ note('No saved home yet.', false); return; }
      const j = await r.json();
      latI.value = j.lat; lonI.value = j.lon; tzI.value = j.tz || '';
      note('Loaded home.', true);
    }catch(e){ note('Failed to load home.', false); }
  };

  // Use current device location
  document.getElementById('btnUseLoc').onclick = async ()=>{
    try{
      const pos = await new Promise((res,rej)=>
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:8000})
      );
      latI.value = pos.coords.latitude.toFixed(6);
      lonI.value = pos.coords.longitude.toFixed(6);
      if(!tzI.value) tzI.value = 'America/Los_Angeles';
      note('Filled from device location.', true);
    }catch(e){ note('Location permission denied or unavailable.', false); }
  };

  // Save home
  document.getElementById('btnSaveHome').onclick = async ()=>{
    const lat = parseFloat(latI.value), lon = parseFloat(lonI.value), tz = tzI.value.trim() || null;
    if(Number.isNaN(lat) || Number.isNaN(lon)){ note('Enter numeric lat/lon.', false); return; }
    try{
      const r = await fetch('/prefs/home',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({lat, lon, tz})
      });
      if(!r.ok){ note('Save failed: ' + await r.text(), false); return; }
      note('Home saved.', true);
    }catch(e){ note('Save failed.', false); }
  };

  // Load saved calendar
  document.getElementById('btnLoadCal').onclick = async ()=>{
    try{
      const r = await fetch('/prefs/calendar');
      if(!r.ok){ note('No calendar saved yet.', false); return; }
      const j = await r.json();
      calI.value = j.ics_url || '';
      note('Loaded calendar.', true);
    }catch(e){ note('Failed to load calendar.', false); }
  };

  // Save calendar
  document.getElementById('btnSaveCal').onclick = async ()=>{
    const ics_url = calI.value.trim();
    if(!ics_url){ note('Enter an ICS URL.', false); return; }
    try{
      const r = await fetch('/prefs/calendar',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ics_url})
      });
      if(!r.ok){ note('Save failed: ' + await r.text(), false); return; }
      note('Calendar saved.', true);
    }catch(e){ note('Save failed.', false); }
  };

  // Try to pre-fill settings on load (non-fatal)
  document.getElementById('btnLoadHome').click();
  document.getElementById('btnLoadCal').click();
})();
</script>
</body>
</html>
