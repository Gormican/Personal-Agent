<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Personal Agent</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; max-width: 900px; margin: 20px auto; }
    h2 { margin-top: 28px; }
    input[type=text] { width: 420px; padding: 6px; }
    button { padding: 6px 10px; margin-left: 6px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:12px; margin:3px; }
    #status { margin: 10px 0; color: #555; }
    pre { background:#f7f7f7; padding:10px; border-radius:6px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>Personal Agent</h1>
  <div id="status"></div>

  <h2>Current Topics Chosen</h2>
  <div id="topics"></div>

  <h2>Add New Topics</h2>
  <input id="topic" type="text" placeholder="e.g., Padres or Taylor Swift"/>
  <button onclick="addTopic()">Add</button>

  <h2>Home location</h2>
  <div>
    City or ZIP: <input id="cityzip" type="text" placeholder="e.g., Coronado or 92118"/>
    Timezone: <input id="tz" type="text" placeholder="America/Los_Angeles"/>
    Units: <input id="units" type="text" placeholder="imperial or metric"/>
    <button onclick="saveHome()">Save</button>
  </div>
  <div style="margin-top:8px;font-size:13px;color:#666">Tip: only fill what you know; you can update later.</div>

  <h2>Calendar</h2>
  <div>
    Secret ICS URL: <input id="ics" type="text" placeholder="https://calendar.google.com/calendar/ical/…/basic.ics"/>
    <button onclick="saveCal()">Save calendar</button>
  </div>

  <h2>Morning report</h2>
  <div>
    <button onclick="getReport()">Get text</button>
    <button onclick="speakReport()">Speak</button>
  </div>
  <pre id="report"></pre>
  <audio id="audio" controls style="display:none"></audio>

  <h2>Study helper</h2>
  <textarea id="question" rows="4" style="width:100%" placeholder="What is the workup of jaundice?"></textarea><br/>
  <button onclick="ask()">Ask</button>
  <pre id="answer"></pre>

<script>
const $ = sel => document.querySelector(sel);
const setStatus = s => $('#status').textContent = s || '';

async function refreshTopics(){
  const r = await fetch('/prefs/news'); const j = await r.json();
  const div = $('#topics'); div.innerHTML='';
  (j.topics||[]).forEach(t=>{
    const span=document.createElement('span'); span.className='pill'; span.textContent=t+' ×';
    span.style.cursor='pointer'; span.onclick=()=>removeTopic(t); div.appendChild(span);
  });
}

async function addTopic(){
  const t = $('#topic').value.trim(); if(!t) return;
  setStatus('Saving topic…');
  await fetch('/prefs/news',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({topics:[t]})});
  $('#topic').value=''; await refreshTopics(); setStatus('Saved.');
}

async function removeTopic(t){
  setStatus('Removing topic…');
  await fetch('/prefs/news/'+encodeURIComponent(t),{method:'DELETE'}); await refreshTopics(); setStatus('Removed.');
}

async function saveHome(){
  const payload={};
  const cz=$('#cityzip').value.trim(); if(cz){ if(/^\d{4,6}$/.test(cz)) payload.zip=cz; else payload.city=cz; }
  const tz=$('#tz').value.trim(); if(tz) payload.tz=tz;
  const units=$('#units').value.trim(); if(units) payload.units=units;
  setStatus('Saving home…');
  const r=await fetch('/prefs/home',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  setStatus(r.ok?'Home saved.':'Save failed.'); 
}

async function saveCal(){
  const ics=$('#ics').value.trim(); if(!ics) return;
  setStatus('Saving calendar…');
  const r=await fetch('/prefs/calendar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ics_url:ics})});
  setStatus(r.ok?'Calendar saved.':'Save failed.');
  if(r.ok) $('#ics').value='';
}

async function getReport(){
  setStatus('Preparing report…');
  const r=await fetch('/report/morning'); const j=await r.json();
  $('#report').textContent=j.text||JSON.stringify(j,null,2); setStatus('');
}

async function speakReport(){
  setStatus('Preparing audio…');
  const r=await fetch('/report/morning/speak');
  if(!r.ok){ const j=await r.json().catch(()=>({})); $('#report').textContent='Audio error: '+JSON.stringify(j); setStatus(''); return; }
  const blob=await r.blob(); const url=URL.createObjectURL(blob);
  const a=$('#audio'); a.src=url; a.style.display='block'; a.play(); setStatus('');
}

async function ask(){
  const q=$('#question').value.trim(); if(!q) return;
  $('#answer').textContent='Thinking…';
  const r=await fetch('/study/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q})});
  const j=await r.json(); $('#answer').textContent=j.answer||JSON.stringify(j,null,2);
}
refreshTopics();
</script>
</body>
</html>

